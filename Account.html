<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cornerstone | Account Access</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Cornerstone dark palette (matches Index) ===== */
    :root{
      --cs-ink:#0b0d12;      /* page background */
      --cs-panel:#10131a;    /* cards/panels */
      --cs-panel-2:#0f1218;  /* secondary panel */
      --cs-brand:#a70b13;    /* primary brand */
      --cs-brand-2:#7f0e15;  /* secondary brand */
      --cs-text:#ffffff;     /* main foreground */
      --cs-muted:rgba(255,255,255,.70);

      /* UI tokens */
      --bg:var(--cs-ink);
      --card:var(--cs-panel);
      --card-sub:var(--cs-panel-2);
      --text:var(--cs-text);
      --muted:var(--cs-muted);
      --brand:var(--cs-brand);
      --brand-2:var(--cs-brand-2);

      --border:rgba(255,255,255,.10);
      --border-strong:rgba(255,255,255,.16);
      --input:#0f1620;
      --focus:rgba(167,11,19,.35);
      --danger:#ff6b81;
      --ok:#59d6a1;

      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --shadow-sm:0 6px 18px rgba(0,0,0,.28);
      --panel-border:rgba(255,255,255,.08);
      --surface:rgba(15,18,27,.85);
    }

    /* ===== Base ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(167,11,19,.18), transparent 60%),
        radial-gradient(1200px 800px at 90% 0%, rgba(64,103,171,.18), transparent 65%),
        linear-gradient(145deg,var(--card-sub) 0%, var(--bg) 65%);
      color:var(--text);
      font:16px/1.6 "Segoe UI","Inter",system-ui,-apple-system,BlinkMacSystemFont,"Apple Color Emoji","Segoe UI Emoji",sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:grid; place-items:center; padding:40px 28px;
      position:relative; isolation:isolate;
    }
    body::before,
    body::after{
      content:"";
      position:fixed;
      width:520px; height:520px;
      z-index:-1; pointer-events:none;
      filter:blur(0px);
    }
    body::before{
      top:-140px; left:-120px;
      background:radial-gradient(circle, rgba(167,11,19,.25), transparent 70%);
    }
    body::after{
      bottom:-220px; right:-120px;
      background:radial-gradient(circle, rgba(83,133,255,.20), transparent 70%);
    }

    .shell{
      width:min(1180px,100%);
      display:grid;
      gap:28px;
      background:var(--surface);
      border:1px solid var(--panel-border);
      border-radius:26px;
      padding:32px 36px 36px;
      box-shadow:0 25px 80px rgba(0,0,0,.55);
      backdrop-filter:blur(18px);
    }
    @media (max-width:720px){
      .shell{padding:24px; border-radius:20px;}
    }
    .brandbar{
      display:flex; flex-wrap:wrap;
      align-items:flex-start; justify-content:space-between;
      gap:16px 24px; padding:0 0 18px;
      border-bottom:1px solid var(--panel-border);
    }
    .brandbar__identity{display:flex; flex-direction:column; gap:6px; max-width:560px}
    .logo{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.45px; font-size:22px;
      text-transform:uppercase;
    }
    .logo b{color:var(--brand)}
    .brand-tag{
      color:var(--muted); font-size:14px; margin:0; line-height:1.5;
    }
    .brand-meta{
      display:grid;
      gap:10px;
      font-size:13px; color:var(--muted);
      text-align:right;
    }
    .brand-meta__row{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      flex-wrap:wrap;
    }
    .brand-meta__label{opacity:.75}
    .brand-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      border:1px solid var(--panel-border);
      background:rgba(255,255,255,.06);
      letter-spacing:.3px; font-size:12px; text-transform:uppercase;
    }
    .brand-pill__dot{
      width:8px; height:8px; border-radius:50%; background:#2dd4bf;
      box-shadow:0 0 10px rgba(45,212,191,.85);
    }
    .brand-link{
      color:#fff; font-weight:650; text-decoration:none;
      border-bottom:1px dotted transparent;
    }
    .brand-link:hover{border-bottom-color:rgba(255,255,255,.45)}
    .brand-cta{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 16px; border-radius:999px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.05);
      color:#fff; text-decoration:none; font-weight:650; letter-spacing:.2px;
      transition:background .15s ease, border-color .15s ease, color .15s ease;
    }
    .brand-cta:hover{
      background:rgba(255,255,255,.12);
      border-color:rgba(255,255,255,.35);
    }
    .brand-cta span{
      font-size:16px;
      opacity:.7;
    }
    .brand-meta .brand-cta{justify-self:flex-end;}
    @media(max-width:600px){
      .brand-meta{text-align:left; align-items:flex-start;}
      .brand-meta__row{justify-content:flex-start;}
      .brand-meta .brand-cta{justify-self:flex-start;}
    }

    .grid{display:grid; gap:22px}
    .two{grid-template-columns:1.05fr 1fr}
    @media (max-width:960px){ .two{grid-template-columns:1fr} }

    .card{
      background:
        linear-gradient(160deg, rgba(255,255,255,.04), rgba(0,0,0,.35)) var(--card);
      border:1px solid var(--panel-border);
      border-radius:var(--radius);
      box-shadow:var(--shadow-sm);
      backdrop-filter:blur(12px);
    }

    /* ===== Auth panel ===== */
    .auth{display:grid; grid-template-rows:auto 1fr auto; gap:18px; padding:22px}
    .section-title{display:flex; align-items:end; justify-content:space-between; gap:12px}
    .title{font-size:18px; font-weight:750; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px}

    .seg{
      display:flex; gap:6px;
      padding:6px;
      border-radius:12px;
      background:rgba(12,16,26,.85);
      border:1px solid var(--panel-border);
    }
    .seg__btn{
      flex:1; padding:10px 14px; text-align:center; border-radius:10px;
      cursor:pointer; border:1px solid transparent; user-select:none;
      color:#b7c4e5; font-weight:650; letter-spacing:.2px;
      background:rgba(255,255,255,.03);
      transition:background .15s ease, color .15s ease, transform .06s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .seg__btn:not(.active){
      color:#9aa8c8;
      border-color:rgba(255,255,255,.04);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }
    .seg__btn:hover{color:#dde6ff; border-color:rgba(255,255,255,.16);}
    .seg__btn.active{
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff;
      border-color:transparent;
      box-shadow:0 12px 26px rgba(167,11,19,.35);
    }
    .seg__btn:active{transform:translateY(1px)}

    form{display:grid; gap:14px}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    @media (max-width:560px){ .row{grid-template-columns:1fr} }

    label{display:grid; gap:8px; font-weight:650; color:#dfe7ffcc; font-size:14px}
    input,select{
      appearance:none; width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid var(--border); background:var(--input); color:var(--text);
      outline:none; transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
    }
    input::placeholder{color:#93a0b0}
    input:focus{box-shadow:0 0 0 3px var(--focus); border-color:#3a2022}
    .help{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:13px}

    label.pw{
      gap:10px;
    }
    .pw__field{
      position:relative;
      display:block;
    }
    .pw__field input{padding-right:108px !important;}
    .pw__field button{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      border:1px solid transparent; background:rgba(255,255,255,.04);
      color:var(--muted); cursor:pointer; padding:6px 10px; border-radius:999px;
      font-size:11px; font-weight:700; letter-spacing:.35px; text-transform:uppercase;
      transition:background .12s ease, color .12s ease, border-color .12s ease;
    }
    .pw__field button:hover{background:rgba(255,255,255,.10); color:var(--text);}
    .pw__field button[aria-pressed="true"]{
      background:rgba(255,255,255,.18);
      border-color:rgba(255,255,255,.25);
      color:var(--text);
    }

    .btnbar{display:flex; gap:10px; align-items:center}
    .btn{
      appearance:none; border:0; cursor:pointer; font-weight:750; letter-spacing:.2px;
      padding:12px 14px; border-radius:12px;
      background:linear-gradient(135deg,var(--brand),var(--brand-2));
      color:#fff; box-shadow:var(--shadow-sm);
      transition:filter .12s ease, transform .06s ease, box-shadow .12s ease;
    }
    .btn:hover{filter:brightness(1.02)}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#141a24; color:var(--text); border:1px solid var(--border); box-shadow:none}
    .btn.danger{background:linear-gradient(135deg,#ff6e7c,#ff3a66); color:#fff}

    .meter{height:6px; border-radius:999px; background:#151c28; border:1px solid rgba(255,255,255,.10); overflow:hidden}
    .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#ff7171,#ffd56a,#5be49c); transition:width .25s ease}

    .toast{padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#0f1621; color:var(--text); font-size:13px}
    .hide{display:none !important}
    .loading{opacity:.6; filter:saturate(.9)}

    /* ===== Profile panel (base) ===== */
    .profile{padding:22px; display:grid; gap:18px}

    /* ===== Compact layout & tighter paddings ===== */
    :root{
      --content-max: 520px;  /* max width for form content */
      --card-pad: 18px;      /* card inner padding */
      --field-py: 10px;      /* input vertical padding */
      --field-px: 12px;      /* input horizontal padding */
      --gap-y: 12px;         /* vertical gap between fields */
      --radius-compact: 10px;
    }
    .grid.two{ grid-template-columns: minmax(0, 560px) minmax(0, 1fr); }
    .card.auth, .card.profile{ padding: var(--card-pad) !important; border-radius: var(--radius-compact) !important; }
    .auth .section-title, .auth .seg, #loginForm, #registerForm, #authCard .help, #authCard .btnbar{
      max-width: var(--content-max); margin-inline: 0;
    }
    form{ gap: var(--gap-y) !important; }
    label{ gap: 6px !important; }
    input, select{ padding: var(--field-py) var(--field-px) !important; border-radius: var(--radius-compact) !important; }
    .seg{ padding: 4px !important; }
    .seg__btn{ padding: 9px 12px !important; }
    .btn{ padding: 10px 14px !important; border-radius: var(--radius-compact) !important; }
    .btn.secondary{ padding: 10px 14px !important; }
    .toast{ border-radius: var(--radius-compact) !important; }
    .help{ margin-top: 2px; }

    /* === Normalize "Remember me" checkbox size & spacing === */
    .help{
      gap: 6px !important;
      font-size: 13px !important;
      align-items: center !important;
    }
    .help input[type="checkbox"]{
      appearance: auto;
      inline-size: 16px;
      block-size: 16px;
      margin: 0;
      padding: 0;
    }
    .help label{ line-height: 1.2; }

    /* ---- Profile card: enhanced look ---- */
    .profile.profile--enhanced{
      padding: 20px !important;
      border-radius: 12px !important;
      background:
        radial-gradient(600px 400px at 90% -10%, rgba(167,11,19,.10), transparent 60%),
        var(--card);
    }
    .profile__header{
      display:flex; align-items:center; gap:14px; padding-bottom:14px;
      border-bottom:1px solid var(--border);
    }
    .avatar{
      position:relative; width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center; font-weight:800; letter-spacing:.3px;
      background:
        radial-gradient(circle at 25% 15%, rgba(255,255,255,.12), transparent 45%),
        linear-gradient(135deg, var(--brand), var(--brand-2));
      color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .avatar::after{ /* subtle ring */
      content:""; position:absolute; inset:-2px; border-radius:inherit;
      border:2px solid rgba(255,255,255,.15);
    }
    .status-dot{
      position:absolute; right:-2px; bottom:-2px; width:12px; height:12px; border-radius:50%;
      background:#22c55e; box-shadow:0 0 0 2px var(--card);
      opacity:0; transform:scale(.8); transition: opacity .15s ease, transform .15s ease;
    }
    [data-signedin="true"] .status-dot{ opacity:1; transform:scale(1); }
    .profile__meta{display:grid; gap:2px}
    .profile__name{font-size:18px; font-weight:750}
    .profile__email{color:var(--muted); font-size:13px}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .chip{
      padding:6px 10px; border-radius:20px; font-size:12px; font-weight:650;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .chip--role{border-color:rgba(167,11,19,.35)}
    .chip--role::before{content:"* "; color:var(--brand)}

    .profile__body{padding-top:14px; display:grid; gap:12px}
    .detail{
      display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:center;
      padding:10px 0; border-top:1px dashed rgba(255,255,255,.10);
    }
    .detail:first-child{border-top:0}
    .detail b{color:#c9d3e8; font-weight:650}

    .profile__actions{display:flex; gap:10px; padding-top:8px}

    .empty--nice{
      border:1px dashed var(--panel-border); border-radius:14px;
      padding:18px; color:var(--muted); background:rgba(15,22,33,.35);
      font-size:14px;
    }
    .empty--nice::before{content:none; display:none}

    /* Motion preferences */
    @media (prefers-reduced-motion:reduce){
      *{transition:none !important}
    }
  </style>
</head>
<body>
  <main class="shell">
    <header class="brandbar">
      <div class="brandbar__identity">
        <div class="logo">Corner<b>Auth</b></div>
        <p class="brand-tag">Single, secure entry point for the Cornerstone SQL Server platform.</p>
      </div>
      <div class="brand-meta">
        <div class="brand-meta__row">
          <span class="brand-meta__label">Need help?</span>
          <a class="brand-link" href="mailto:support@cornerstone.com.au">support@cornerstone.com.au</a>
        </div>
        <a class="brand-cta" href="Index.html">
          <span aria-hidden="true">&larr;</span>
          Back to Home
        </a>
      </div>
    </header>

    <div class="grid two">
      <!-- ===== AUTH (left) ===== -->
      <section class="card auth" id="authCard">
        <div class="section-title">
          <div class="title">Account Access</div>
          <div class="subtitle">Sign in or create an account</div>
        </div>

        <div class="seg" role="tablist" aria-label="Authentication">
          <button class="seg__btn active" data-tab="login" role="tab" aria-selected="true">Login</button>
          <button class="seg__btn" data-tab="register" role="tab" aria-selected="false">Create account</button>
        </div>

        <!-- LOGIN -->
        <form id="loginForm" autocomplete="on" novalidate aria-labelledby="tab-login">
          <label>
            Email
            <input id="loginEmail" type="email" inputmode="email" autocomplete="email" required placeholder="you@company.com" />
          </label>
          <label class="pw">
            Password
            <span class="pw__field">
              <input id="loginPassword" type="password" autocomplete="current-password" required placeholder="********" />
              <button type="button" data-toggle="#loginPassword" aria-label="Show or hide password" aria-pressed="false">Show</button>
            </span>
          </label>
          <div class="help">
            <input id="remember" type="checkbox" checked style="accent-color:var(--brand)" />
            <label for="remember" style="cursor:pointer">Remember me on this device</label>
          </div>
          <div class="btnbar">
            <button class="btn" id="loginBtn" type="submit">Sign in</button>
            <div id="loginMsg" class="toast hide" aria-live="polite"></div>
          </div>
        </form>

        <!-- REGISTER -->
        <form id="registerForm" class="hide" autocomplete="on" novalidate aria-labelledby="tab-register">
          <div class="row">
            <label>First name
              <input id="firstName" required autocomplete="given-name" />
            </label>
            <label>Last name
              <input id="lastName" required autocomplete="family-name" />
            </label>
          </div>
          <label>Email
            <input id="regEmail" type="email" inputmode="email" autocomplete="email" required placeholder="you@company.com" />
          </label>
          <label>Company (optional)
            <input id="company" placeholder="Cornerstone Pty Ltd" />
          </label>
          <label>Role (optional)
            <input id="role" placeholder="Administrator" />
          </label>
          <label class="pw">Password
            <span class="pw__field">
              <input id="regPassword" type="password" autocomplete="new-password" required minlength="8" placeholder="At least 8 characters" />
              <button type="button" data-toggle="#regPassword" aria-label="Show or hide password" aria-pressed="false">Show</button>
            </span>
          </label>
          <div class="meter" aria-hidden="true"><i id="pwBar"></i></div>
          <div class="help" id="pwHint">Use 12+ chars with a mix of letters, numbers & symbols.</div>

          <div class="btnbar">
            <button class="btn" id="registerBtn" type="submit">Create account</button>
            <div id="registerMsg" class="toast hide" aria-live="polite"></div>
          </div>
        </form>

        <footer class="help">
          Please remeber to keep your account credentials secure.
        </footer>
      </section>

      <!-- ===== PROFILE (right, enhanced) ===== -->
      <section class="card profile profile--enhanced" id="profileCard" data-signedin="false">
        <div class="profile__header">
          <div class="avatar" id="pfAvatar">
            <span id="pfInitials">--</span>
            <i class="status-dot" aria-hidden="true"></i>
          </div>
          <div class="profile__meta">
            <div class="profile__name">
              <span id="pfFirst">--</span> <span id="pfLast"></span>
            </div>
            <div class="profile__email" id="pfEmail">--</div>
            <div class="chips">
              <span class="chip chip--role" id="pfRoleChip" hidden>Role</span>
              <span class="chip" id="pfCompanyChip" hidden>Company</span>
            </div>
          </div>
        </div>

        <div id="profileEmpty" class="empty--nice">No active session yet.</div>

        <div id="profileData" class="profile__body hide">
          <div class="detail"><b>Created</b><div id="pfCreated">--</div></div>
          <div class="profile__actions">
            <button class="btn secondary" id="refreshBtn" type="button">Refresh</button>
            <button class="btn danger" id="logoutBtn" type="button">Sign out</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ---------- helpers ----------
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const ui = {
      segBtns: $$('.seg__btn'),
      loginForm: $('#loginForm'),
      registerForm: $('#registerForm'),
      loginMsg: $('#loginMsg'),
      registerMsg: $('#registerMsg'),
      refreshBtn: $('#refreshBtn'),
      logoutBtn: $('#logoutBtn'),
    };

    function show(el){ el.classList.remove('hide'); }
    function hide(el){ el.classList.add('hide'); }
    function toast(el, msg, kind='info'){
      el.textContent = msg;
      el.classList.remove('hide');
      el.style.borderColor = kind==='error' ? 'var(--danger)' : (kind==='ok' ? '#2a5a46':'var(--border)');
      el.style.background  = kind==='error' ? '#2a1014' : (kind==='ok' ? '#0f1f1a' : '#0f1621');
    }
    function clearToast(el){
      el.textContent=''; el.classList.add('hide');
      el.style.borderColor='var(--border)'; el.style.background='#0f1621';
    }
    function busy(scopeEl, on){
      scopeEl.classList.toggle('loading', on);
      for (const el of scopeEl.querySelectorAll('input,select,button')) el.disabled = on;
    }
    const emailValid = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

    // ---------- segmented control (tabs) ----------
    ui.segBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        ui.segBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('active'); btn.setAttribute('aria-selected','true');
        if (btn.dataset.tab === 'login'){ hide($('#registerForm')); show($('#loginForm')); clearToast($('#registerMsg')); }
        else { hide($('#loginForm')); show($('#registerForm')); clearToast($('#loginMsg')); }
      });
    });

    // ---------- password show/hide ----------
    document.addEventListener('click', (e) => {
      const t = e.target.closest('button[data-toggle]');
      if (!t) return;
      const input = document.querySelector(t.dataset.toggle);
      if (input) input.type = input.type === 'password' ? 'text' : 'password';
    });

    // ---------- password strength meter ----------
    const strength = v => {
      let s = 0;
      if (v.length >= 8) s++;
      if (v.length >= 12) s++;
      if (/[A-Z]/.test(v) && /[a-z]/.test(v)) s++;
      if (/\d/.test(v)) s++;
      if (/[^\w\s]/.test(v)) s++;
      return Math.min(5, s);
    };
    document.addEventListener('input', (e) => {
      if (e.target.id !== 'regPassword') return;
      const score = strength(e.target.value);
      $('#pwBar').style.width = (score*20)+'%';
      $('#pwHint').textContent = score >= 4 ? 'Strong password ready.' : 'Use 12+ characters with mixed types.';
    });

    // ---------- API ----------
    const API = {
      async me(){ const r = await fetch('/api/me', { credentials:'include' }); return r.ok ? r.json() : {}; },
      async login(email, password){
        const r = await fetch('/api/auth/login', {
          method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include',
          body: JSON.stringify({ email, password })
        });
        return r.json();
      },
      async register(payload){
        const r = await fetch('/api/auth/register', {
          method:'POST', headers:{ 'Content-Type':'application/json' }, credentials:'include',
          body: JSON.stringify(payload)
        });
        return r.json();
      },
      async logout(){ const r = await fetch('/api/auth/logout', { method:'POST', credentials:'include' }); return r.json(); }
    };

    // ---------- profile render (enhanced) ----------
    function renderProfile(user){
      const card = document.getElementById('profileCard');
      const profileData = document.getElementById('profileData');
      const profileEmpty = document.getElementById('profileEmpty');

      if (!user){
        card.setAttribute('data-signedin','false');
        profileData.classList.add('hide');
        profileEmpty.classList.remove('hide');
        document.getElementById('pfInitials').textContent = '--';
        document.getElementById('pfFirst').textContent = '--';
        document.getElementById('pfLast').textContent = '';
        document.getElementById('pfEmail').textContent = '--';
        document.getElementById('pfRoleChip').hidden = true;
        document.getElementById('pfCompanyChip').hidden = true;
        document.getElementById('pfCreated').textContent = '--';
        return;
      }

      card.setAttribute('data-signedin','true');
      profileEmpty.classList.add('hide');
      profileData.classList.remove('hide');

      // Fill fields
      const first = user.first_name ?? '';
      const last  = user.last_name  ?? '';
      document.getElementById('pfFirst').textContent = first || '--';
      document.getElementById('pfLast').textContent  = last ? ' ' + last : '';
      document.getElementById('pfEmail').textContent = user.email ?? '--';

      // Chips
      const roleChip = document.getElementById('pfRoleChip');
      if (user.role){ roleChip.textContent = user.role; roleChip.hidden = false; }
      else { roleChip.hidden = true; }

      const companyChip = document.getElementById('pfCompanyChip');
      if (user.company){ companyChip.textContent = user.company; companyChip.hidden = false; }
      else { companyChip.hidden = true; }

      // Created date
      const d = user.created_at ? new Date(user.created_at) : null;
      document.getElementById('pfCreated').textContent = d ? d.toLocaleString() : '--';

      // Avatar initials
      const initials = ((first[0] || '') + (last[0] || '')).toUpperCase() || '--';
      document.getElementById('pfInitials').textContent = initials;
    }

    async function refreshMe(){
      try{ const { user } = await API.me(); renderProfile(user); }
      catch{ renderProfile(null); }
    }

    // ---------- submit: login ----------
    $('#loginForm').addEventListener('submit', async (e) => {
      e.preventDefault(); clearToast($('#loginMsg'));
      const email = $('#loginEmail').value.trim();
      const password = $('#loginPassword').value;
      if (!emailValid(email)) return toast($('#loginMsg'), 'Please enter a valid email', 'error');
      if (!password) return toast($('#loginMsg'), 'Password is required', 'error');

      busy($('#loginForm'), true);
      try{
        const res = await API.login(email, password);
        if (res && res.ok){ toast($('#loginMsg'), 'Signed in', 'ok'); await refreshMe(); }
        else { toast($('#loginMsg'), (res && res.error) || 'Invalid credentials', 'error'); }
      }catch{ toast($('#loginMsg'), 'Network or server error', 'error'); }
      finally{ busy($('#loginForm'), false); }
    });

    // ---------- submit: register ----------
    $('#registerForm').addEventListener('submit', async (e) => {
      e.preventDefault(); clearToast($('#registerMsg'));
      const payload = {
        first_name: $('#firstName').value.trim(),
        last_name:  $('#lastName').value.trim(),
        email:      $('#regEmail').value.trim(),
        company:    $('#company').value.trim() || null,
        role:       $('#role').value.trim() || null,
        password:   $('#regPassword').value
      };
      if (!payload.first_name || !payload.last_name) return toast($('#registerMsg'), 'First and last name required', 'error');
      if (!emailValid(payload.email)) return toast($('#registerMsg'), 'Please enter a valid email', 'error');
      if (!payload.password || payload.password.length < 8) return toast($('#registerMsg'), 'Use at least 8 characters', 'error');

      busy($('#registerForm'), true);
      try{
        const res = await API.register(payload);
        if (res && res.ok){
          toast($('#registerMsg'), 'Account created. You are now signed in.', 'ok');
          await refreshMe();
          // switch to login tab
          ui.segBtns.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
          ui.segBtns[0].classList.add('active'); ui.segBtns[0].setAttribute('aria-selected','true');
          $('#registerForm').classList.add('hide'); $('#loginForm').classList.remove('hide');
        } else {
          toast($('#registerMsg'), (res && res.error) || 'Could not create account', 'error');
        }
      }catch{ toast($('#registerMsg'), 'Network or server error', 'error'); }
      finally{ busy($('#registerForm'), false); }
    });

    // ---------- actions ----------
    ui.logoutBtn.addEventListener('click', async () => {
      try { await API.logout(); } catch {}
      await refreshMe();
      toast($('#loginMsg'), 'Signed out', 'ok');
      ui.segBtns.forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
      ui.segBtns[0].classList.add('active'); ui.segBtns[0].setAttribute('aria-selected','true');
      $('#registerForm').classList.add('hide'); $('#loginForm').classList.remove('hide');
    });
    ui.refreshBtn.addEventListener('click', refreshMe);

    // initial load
    refreshMe();
  </script>
</body>
</html>
