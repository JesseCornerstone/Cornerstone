var podEl=document.getElementById('podPdf');

if(podEl){podEl.addEventListener('change',function(e){

  var input=e.target;

  var file=input.files&&input.files[0];

  if(!file){

    setPodStatus('No PoD selected.',false);

    return;

  }

  var name=(file.name||'PoD').trim();
  if(!/\.pdf$/i.test(name)){
    setPodStatus('That file must be a .pdf ('+name+').',true);
    input.value='';
    return;
  }
  if(!window.pdfjsLib || !window.pdfjsLib.getDocument){

    setPodStatus('PDF engine not ready. Refresh the page and try again.',true);

    input.value='';

    return;

  }

  setPodStatus('Reading '+name+'...',false);

  var reader=new FileReader();

  var statusToken=null;

  reader.onload=function(){

    statusToken=showStatus('Parsing PoD...');

    var u8=new Uint8Array(reader.result);

    Promise.resolve()

      .then(function(){return window.pdfjsLib.getDocument({data:u8}).promise;})

      .then(function(){return parsePoD(u8);})

      .then(maybeHydrateLotPlanGeometry)

      .then(function(res){

        if(statusToken!==null) hideStatus(statusToken);

        res=res||{};

        var addr=res.addr||null;

        var lots=res.lots||[];

        var coords=res.coords||[];

        var lotPlan=res.lotPlan||null;

        var outlineCenter=null;

        if(coords.length>=3){

          outlineCenter=showPodOutlineFromCoords(coords);

        }else if(res.lotPlanGeom && res.lotPlanGeom.rings){

          outlineCenter=showPodOutlineFromRings(res.lotPlanGeom.rings);

        }else{

          clearPodOutline();

        }

        var autoTarget=null;

        if(res.center && inAU(res.center.lat,res.center.lon)){autoTarget=res.center;}

        else if(outlineCenter && inAU(outlineCenter.lat,outlineCenter.lon)){autoTarget=outlineCenter;}

        if(addr){

          var aEl=document.getElementById('addr');

          if(aEl) aEl.value=addr;

        }

        currentPodState.addr=addr;

        currentPodState.coords=coords;

        currentPodState.lots=lots;

        currentPodState.lotPlan=lotPlan;

        if(autoTarget){

          placeFromForm(autoTarget.lat,autoTarget.lon,{zoom:true});

        }else if(addr){

          centerOnAddress(addr);

        }

        var sel=lotSelect; sel.innerHTML='<option value=>- Select lot -</option>';

        for(var i=0;i<Math.min(lots.length,60);i++){

          var o=document.createElement('option');o.value=lots[i].id; o.textContent='Lot '+lots[i].id; sel.appendChild(o);

        }

        placeOnLotBtn.disabled = lots.length===0; clearLotsBtn.disabled = lots.length>0;

        showPodSummary(addr, coords.length, lots.length, lotPlan);

        var summaryParts=[];

        if(addr) summaryParts.push(addr);

        if(lotPlan && lotPlan.lot && lotPlan.plan) summaryParts.push('Lot '+lotPlan.lot+' '+lotPlan.plan);

        setPodStatus('PoD loaded'+(summaryParts.length?': '+summaryParts.join(' | '):''),false);

        input.value='';

      })

      .catch(function(err){

        if(statusToken!==null) hideStatus(statusToken);

        var msg=(err&&err.message)||err||'Unknown error';

        console.error('PoD parse failed',err);

        setPodStatus('PoD parse failed: '+msg,true);

        alert('PoD parse failed: '+msg);

        input.value='';

      });

  };

  reader.onerror=function(){

    if(statusToken!==null) hideStatus(statusToken);

    setPodStatus('Could not read that PDF.',true);

    input.value='';

  };

  reader.readAsArrayBuffer(file);

})}



